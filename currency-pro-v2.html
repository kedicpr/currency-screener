<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–°–∫—Ä–∏–Ω–µ—Ä –≤–∞–ª—é—Ç Pro+</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #f4f6f9;
      --card-bg: white;
      --text: #333;
      --accent: #3498db;
      --hover: #f1f7ff;
      --border: #ddd;
      --success: #27ae60;
      --up: #2ecc71;
      --down: #e74c3c;
    }
    .dark-mode {
      --bg: #1a1a1a;
      --card-bg: #2d2d2d;
      --text: #e0e0e0;
      --accent: #1abc9c;
      --hover: #3a3a3a;
      --border: #555;
      --success: #2ecc71;
    }
    body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
    .theme-toggle { background: var(--accent); color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; }
    .section { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border); }
    th { background-color: var(--accent); color: white; }
    tr:hover { background-color: var(--hover); }
    .rate { font-weight: 500; }
    .change { font-size: 0.9em; padding: 2px 6px; border-radius: 3px; color: white; }
    .up { background: var(--up); }
    .down { background: var(--down); }
    .search { width: 100%; padding: 10px; margin-bottom: 15px; font-size: 16px; border: 1px solid var(--border); border-radius: 5px; }
    .tooltip { position: relative; cursor: help; }
    .tooltip::after { content: attr(data-tip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 5px 10px; border-radius: 4px; font-size: 14px; white-space: nowrap; opacity: 0; transition: opacity 0.3s; }
    .tooltip:hover::after { opacity: 1; }
    #chart-container { height: 300px; margin-top: 20px; }
    .checkbox-group { margin: 10px 0; }
    .checkbox-group label { margin-right: 15px; font-size: 14px; }
  </style>
</head>
<body class="light-mode">
  <div class="container">
    <div class="header">
      <h1>üí∞ –°–∫—Ä–∏–Ω–µ—Ä –≤–∞–ª—é—Ç Pro+</h1>
      <button class="theme-toggle" id="themeToggle">üåô –¢—ë–º–Ω–∞—è</button>
    </div>

    <!-- –ü–æ–∏—Å–∫ -->
    <input type="text" class="search" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –≤–∞–ª—é—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: –µ–≤—Ä–æ, USD, —Ñ—É–Ω—Ç)...">

    <!-- –¢–∞–±–ª–∏—Ü–∞ -->
    <div class="section">
      <h2>üìä –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç</h2>
      <table id="currency-table">
        <thead>
          <tr>
            <th>‚Ññ</th>
            <th>–í–∞–ª—é—Ç–∞</th>
            <th>–ö–æ–¥</th>
            <th>–ö—É—Ä—Å –∫ —Ä—É–±–ª—é</th>
            <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫ -->
    <div class="section">
      <h2>üìà –î–∏–Ω–∞–º–∏–∫–∞ –∫—É—Ä—Å–∞</h2>
      <div class="checkbox-group">
        <label><input type="checkbox" value="USD" checked> USD</label>
        <label><input type="checkbox" value="EUR" checked> EUR</label>
        <label><input type="checkbox" value="GBP"> GBP</label>
      </div>
      <div id="chart-container">
        <canvas id="mainChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    const tableBody = document.getElementById("table-body");
    const searchInput = document.getElementById("searchInput");
    const themeToggle = document.getElementById("themeToggle");
    const ctx = document.getElementById("mainChart").getContext("2d");
    let mainChart;
    let currencyRates = {};
    let prevRates = {};

    const currencies = [
      { code: "USD", name: "–î–æ–ª–ª–∞—Ä –°–®–ê", tip: "–ê–º–µ—Ä–∏–∫–∞–Ω—Å–∫–∏–π –¥–æ–ª–ª–∞—Ä" },
      { code: "EUR", name: "–ï–≤—Ä–æ", tip: "–ï–≤—Ä–æ–ø–µ–π—Å–∫–∏–π —Å–æ—é–∑" },
      { code: "GBP", name: "–§—É–Ω—Ç —Å—Ç–µ—Ä–ª–∏–Ω–≥–æ–≤", tip: "–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è" },
      { code: "CHF", name: "–®–≤–µ–π—Ü–∞—Ä—Å–∫–∏–π —Ñ—Ä–∞–Ω–∫", tip: "–®–≤–µ–π—Ü–∞—Ä–∏—è" },
      { code: "JPY", name: "–Ø–ø–æ–Ω—Å–∫–∞—è –∏–µ–Ω–∞", tip: "–Ø–ø–æ–Ω–∏—è" },
      { code: "CNY", name: "–ö–∏—Ç–∞–π—Å–∫–∏–π —é–∞–Ω—å", tip: "–ö–∏—Ç–∞–π" },
      { code: "KZT", name: "–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∏–π —Ç–µ–Ω–≥–µ", tip: "–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω" }
    ];

    // === 1. –¢–µ–º–∞ ===
    themeToggle.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
      themeToggle.textContent = document.body.classList.contains("dark-mode") ? "‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è" : "üåô –¢—ë–º–∫–∞—è";
      localStorage.setItem("theme", document.body.classList.contains("dark-mode"));
    });

    if (localStorage.getItem("theme") === "true") {
      document.body.classList.add("dark-mode");
      themeToggle.textContent = "‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è";
    }

    // === 2. –ü–æ–∏—Å–∫ ===
    searchInput.addEventListener("input", () => {
      const term = searchInput.value.toLowerCase();
      document.querySelectorAll("#table-body tr").forEach(tr => {
        const text = tr.textContent.toLowerCase();
        tr.style.display = text.includes(term) ? "" : "none";
      });
    });

    // === 3. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ===
    function requestNotificationPermission() {
      if ("Notification" in window) {
        Notification.requestPermission();
      }
    }
    requestNotificationPermission();

    function showNotification(msg) {
      if (Notification.permission === "granted") {
        new Notification("–ö—É—Ä—Å –≤–∞–ª—é—Ç", { body: msg });
      }
    }

    // === 4. –ó–∞–≥—Ä—É–∑–∫–∞ –∫—É—Ä—Å–æ–≤ ===
    async function loadRates() {
      try {
        const res = await fetch("https://www.cbr-xml-daily.ru/daily_json.js");
        const data = await res.json();

        tableBody.innerHTML = "";
        prevRates = { ...currencyRates };
        currencyRates = {};

        currencies.forEach((curr, i) => {
          const val = data.Valute[curr.code];
          if (val) {
            const rate = val.Value;
            const prev = prevRates[curr.code] || rate;
            const change = ((rate - prev) / prev * 100).toFixed(2);
            const isUp = rate > prev;

            const tr = document.createElement("tr");

            tr.innerHTML = `
              <td>${i+1}</td>
              <td class="tooltip" data-tip="${curr.tip}">${curr.name}</td>
              <td><strong>${curr.code}</strong></td>
              <td class="rate">${rate.toFixed(4)}</td>
              <td>
                <span class="change ${isUp ? 'up' : 'down'}">
                  ${isUp ? '‚Üë' : '‚Üì'} ${Math.abs(change)}%
                </span>
              </td>
            `;

            tableBody.appendChild(tr);
            currencyRates[curr.code] = rate;

            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            if (curr.code === "EUR" && rate > 110) {
              showNotification(`‚ö†Ô∏è –ï–≤—Ä–æ –¥–æ—Å—Ç–∏–≥ ${rate.toFixed(2)} —Ä—É–±!`);
            }
          }
        });

        updateChart();
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞:", e);
      }
    }

    // === 5. –ì—Ä–∞—Ñ–∏–∫ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π) ===
    function updateChart() {
      const checked = Array.from(document.querySelectorAll(".checkbox-group input:checked")).map(cb => cb.value);
      if (checked.length === 0) return;

      const dates = [];
      const datasets = [];

      // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ 7 –¥–Ω–µ–π
      let currentDate = new Date();
      currentDate.setDate(currentDate.getDate() - 7);

      for (let i = 0; i < 8; i++) {
        const dateStr = currentDate.toISOString().split('T')[0];
        dates.push(dateStr);
        currentDate.setDate(currentDate.getDate() + 1);
      }

      checked.forEach(code => {
        const data = dates.map(date => {
          // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å localStorage
          return 0; // –£–ø—Ä–æ—â—ë–Ω–Ω–æ ‚Äî –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –±–µ—Ä—ë—Ç—Å—è –∏–∑ –∞—Ä—Ö–∏–≤–∞
        });
        datasets.push({
          label: `${code}/RUB`,
          data: data,
          borderColor: { USD: '#e67e22', EUR: '#e74c3c', GBP: '#9b59b6' }[code],
          fill: false,
          tension: 0.3
        });
      });

      if (mainChart) mainChart.destroy();
      mainChart = new Chart(ctx, {
        type: 'line',
        data: { labels: dates, datasets },
        options: { responsive: true }
      });
    }

    document.querySelectorAll(".checkbox-group input").forEach(cb => {
      cb.addEventListener("change", updateChart);
    });

    // === –ó–∞–ø—É—Å–∫ ===
    loadRates();
    setInterval(loadRates, 300000); // –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
  </script>
</body>
</html>